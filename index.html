<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home | Authrim Example</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Authrim Example</h1>
      <p>@authrim/web SDK Demo</p>
    </header>

    <!-- Loading State -->
    <div id="loading" class="card">
      <div class="status status-loading">
        <span class="spinner"></span> Checking authentication status...
      </div>
    </div>

    <!-- Logged Out State -->
    <div id="logged-out" class="card hidden">
      <h2>Welcome</h2>
      <p style="color: var(--gray-500); margin-bottom: 1rem;">
        This sample demonstrates authentication features using the Authrim SDK.
      </p>
      <a href="login.html" class="btn btn-primary">Sign In</a>
    </div>

    <!-- Logged In State -->
    <div id="logged-in" class="card hidden">
      <div class="status status-success" style="margin-bottom: 1rem;">
        âœ“ You are signed in
      </div>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-details">
          <h3 id="user-name">-</h3>
          <p id="user-email">-</p>
        </div>
      </div>
      <div class="session-info" style="margin: 1rem 0; padding: 0.75rem; background: var(--gray-50); border-radius: 0.5rem; font-size: 0.75rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
          <span style="color: var(--gray-500);">Session ID:</span>
          <code id="session-id" style="color: var(--gray-700);">-</code>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: var(--gray-500);">Expires:</span>
          <span id="session-expires" style="color: var(--gray-700);">-</span>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <a href="profile.html" class="btn btn-primary" style="flex: 1;">View Profile</a>
        <button id="logout-btn" class="btn btn-secondary" style="flex: 1;">
          <span class="btn-text">Sign Out</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
      </div>
    </div>

    <!-- Setup State (not configured) -->
    <div id="setup" class="card hidden">
      <h2>Setup Required</h2>
      <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem;">
        Configure these URLs in your Authrim Admin panel, then edit <code>config.js</code>.
      </p>

      <div class="setup-urls">
        <div class="setup-url-item">
          <label>Callback URL</label>
          <div class="setup-url-copy">
            <code id="callback-url"></code>
            <button class="btn-copy" onclick="copyUrl('callback-url')" title="Copy">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
          </div>
        </div>

        <div class="setup-url-item">
          <label>Allowed Origin</label>
          <div class="setup-url-copy">
            <code id="origin-url"></code>
            <button class="btn-copy" onclick="copyUrl('origin-url')" title="Copy">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
          </div>
        </div>
      </div>

      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
        <p style="color: var(--gray-500); font-size: 0.75rem; margin-bottom: 0.5rem;">After configuring Admin panel:</p>
        <ol style="color: var(--gray-600); font-size: 0.875rem; margin-left: 1.25rem;">
          <li>Edit <code>config.js</code> with your issuer and clientId</li>
          <li>Commit and push changes</li>
          <li>Reload this page</li>
        </ol>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="card hidden">
      <div class="status status-error" id="error-message"></div>
      <button onclick="location.reload()" class="btn btn-secondary">Retry</button>
    </div>

    <footer>
      <p>Powered by <a href="https://authrim.com" target="_blank">Authrim</a></p>
    </footer>
  </div>

  <!-- Load SDK -->
  <script src="https://unpkg.com/@authrim/web@latest/dist/authrim-web.umd.global.js"></script>
  <script src="config.js"></script>
  <script>
    // State elements
    const $loading = document.getElementById('loading');
    const $loggedOut = document.getElementById('logged-out');
    const $loggedIn = document.getElementById('logged-in');
    const $setup = document.getElementById('setup');
    const $error = document.getElementById('error');
    const $errorMessage = document.getElementById('error-message');
    const $callbackUrl = document.getElementById('callback-url');
    const $originUrl = document.getElementById('origin-url');
    const $userName = document.getElementById('user-name');
    const $userEmail = document.getElementById('user-email');
    const $userAvatar = document.getElementById('user-avatar');
    const $sessionId = document.getElementById('session-id');
    const $sessionExpires = document.getElementById('session-expires');
    const $logoutBtn = document.getElementById('logout-btn');

    // Switch state
    function showState(state) {
      $loading.classList.add('hidden');
      $loggedOut.classList.add('hidden');
      $loggedIn.classList.add('hidden');
      $setup.classList.add('hidden');
      $error.classList.add('hidden');

      switch (state) {
        case 'loading':
          $loading.classList.remove('hidden');
          break;
        case 'logged-out':
          $loggedOut.classList.remove('hidden');
          break;
        case 'logged-in':
          $loggedIn.classList.remove('hidden');
          break;
        case 'setup':
          $setup.classList.remove('hidden');
          break;
        case 'error':
          $error.classList.remove('hidden');
          break;
      }
    }

    // Show setup with URLs
    function showSetup() {
      $callbackUrl.textContent = window.location.origin + '/callback.html';
      $originUrl.textContent = window.location.origin;
      showState('setup');
    }

    // Copy URL to clipboard
    function copyUrl(elementId) {
      var text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(function() {
        var btn = document.getElementById(elementId).nextElementSibling;
        btn.style.color = 'var(--success)';
        setTimeout(function() { btn.style.color = ''; }, 1000);
      });
    }

    // Show user info
    function showUser(user, session) {
      $userName.textContent = user.name || 'User';
      $userEmail.textContent = user.email || '-';
      $userAvatar.textContent = (user.name || user.email || '?').charAt(0).toUpperCase();

      // Show session info
      if (session) {
        $sessionId.textContent = session.id ? session.id.substring(0, 8) + '...' : '-';
        if (session.expiresAt) {
          const expires = new Date(session.expiresAt);
          $sessionExpires.textContent = expires.toLocaleString();
        }
      }

      showState('logged-in');
    }

    // Show error
    function showError(message) {
      $errorMessage.textContent = message;
      showState('error');
    }

    // Button loading state
    function setButtonLoading(btn, loading) {
      const $text = btn.querySelector('.btn-text');
      const $spinner = btn.querySelector('.btn-spinner');
      if (loading) {
        btn.disabled = true;
        if ($text) $text.classList.add('hidden');
        if ($spinner) $spinner.classList.remove('hidden');
      } else {
        btn.disabled = false;
        if ($text) $text.classList.remove('hidden');
        if ($spinner) $spinner.classList.add('hidden');
      }
    }

    // Main
    async function main() {
      try {
        // Check configuration
        if (!window.AUTHRIM_CONFIG?.issuer || window.AUTHRIM_CONFIG.issuer === 'https://your-tenant.authrim.com') {
          showSetup();
          return;
        }

        // Initialize SDK
        const auth = await AuthrimWeb.createAuthrim({
          issuer: window.AUTHRIM_CONFIG.issuer,
          clientId: window.AUTHRIM_CONFIG.clientId,
        });

        // Check session
        const { data, error } = await auth.session.get();

        if (error) {
          console.error('Session error:', error);
          showState('logged-out');
          return;
        }

        if (data && data.user) {
          showUser(data.user, data.session);
        } else {
          showState('logged-out');
        }

        // Logout button
        $logoutBtn.addEventListener('click', async () => {
          setButtonLoading($logoutBtn, true);

          try {
            await auth.signOut();
            showState('logged-out');
          } catch (e) {
            console.error('Logout error:', e);
            showError('Failed to sign out.');
          } finally {
            setButtonLoading($logoutBtn, false);
          }
        });

      } catch (e) {
        console.error('Initialization error:', e);
        showError('Initialization failed: ' + e.message);
      }
    }

    main();
  </script>
</body>
</html>
