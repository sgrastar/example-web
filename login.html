<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In | Authrim Example</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Sign In</h1>
      <p>Choose your preferred sign-in method</p>
    </header>

    <!-- Status Message -->
    <div id="status" class="status hidden"></div>

    <!-- Passkey Login -->
    <div class="card">
      <h2>Passkey</h2>
      <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem;">
        Sign in with biometrics or security key
      </p>
      <button id="passkey-login-btn" class="btn btn-primary">
        <span class="btn-text">Sign in with Passkey</span>
        <span class="btn-spinner hidden"><span class="spinner"></span></span>
      </button>
      <button id="passkey-signup-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">
        <span class="btn-text">Sign up with Passkey</span>
        <span class="btn-spinner hidden"><span class="spinner"></span></span>
      </button>
    </div>

    <!-- Email Code Login -->
    <div class="card">
      <h2>Email Code</h2>

      <!-- Step 1: Email Input -->
      <div id="email-step">
        <div class="form-group">
          <label for="email-input">Email Address</label>
          <input type="email" id="email-input" placeholder="you@example.com">
        </div>
        <button id="send-code-btn" class="btn btn-primary">
          <span class="btn-text">Send Verification Code</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
      </div>

      <!-- Step 2: Code Verification -->
      <div id="code-step" class="hidden">
        <p style="color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem;">
          Enter the code sent to <span id="sent-email"></span>
        </p>
        <div class="form-group">
          <label for="code-input">Verification Code (6 digits)</label>
          <input type="text" id="code-input" placeholder="123456" maxlength="6" pattern="[0-9]*" inputmode="numeric">
        </div>
        <button id="verify-code-btn" class="btn btn-primary">
          <span class="btn-text">Verify Code</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
        <button id="back-to-email-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">
          Change Email Address
        </button>
      </div>
    </div>

    <!-- Social Login -->
    <div class="card">
      <h2>Social Login</h2>
      <div class="social-buttons">
        <button id="google-btn" class="btn btn-google">
          <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          <span class="btn-text">Sign in with Google</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
        <button id="github-btn" class="btn btn-github">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          <span class="btn-text">Sign in with GitHub</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
        <button id="apple-btn" class="btn btn-apple">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
          <span class="btn-text">Sign in with Apple</span>
          <span class="btn-spinner hidden"><span class="spinner"></span></span>
        </button>
      </div>
    </div>

    <!-- Back to Home -->
    <div style="text-align: center;">
      <a href="index.html">&larr; Back to Home</a>
    </div>

    <footer>
      <p>Powered by <a href="https://authrim.com" target="_blank">Authrim</a></p>
    </footer>
  </div>

  <!-- Load SDK -->
  <script src="https://unpkg.com/@authrim/web@latest/dist/authrim-web.umd.global.js"></script>
  <script src="config.js"></script>
  <script>
    // Elements
    const $status = document.getElementById('status');
    const $passkeyLoginBtn = document.getElementById('passkey-login-btn');
    const $passkeySignupBtn = document.getElementById('passkey-signup-btn');
    const $emailStep = document.getElementById('email-step');
    const $codeStep = document.getElementById('code-step');
    const $emailInput = document.getElementById('email-input');
    const $codeInput = document.getElementById('code-input');
    const $sendCodeBtn = document.getElementById('send-code-btn');
    const $verifyCodeBtn = document.getElementById('verify-code-btn');
    const $backToEmailBtn = document.getElementById('back-to-email-btn');
    const $sentEmail = document.getElementById('sent-email');
    const $googleBtn = document.getElementById('google-btn');
    const $githubBtn = document.getElementById('github-btn');
    const $appleBtn = document.getElementById('apple-btn');

    let auth = null;
    let currentEmail = '';

    // Show status
    function showStatus(message, type) {
      $status.textContent = message;
      $status.className = 'status status-' + type;
      $status.classList.remove('hidden');
    }

    function hideStatus() {
      $status.classList.add('hidden');
    }

    // Button loading state
    function setButtonLoading(btn, loading) {
      const $text = btn.querySelector('.btn-text');
      const $spinner = btn.querySelector('.btn-spinner');
      if (loading) {
        btn.disabled = true;
        if ($text) $text.classList.add('hidden');
        if ($spinner) $spinner.classList.remove('hidden');
      } else {
        btn.disabled = false;
        if ($text) $text.classList.remove('hidden');
        if ($spinner) $spinner.classList.add('hidden');
      }
    }

    // On login success
    function onLoginSuccess() {
      showStatus('Login successful! Redirecting...', 'success');
      setTimeout(function() {
        window.location.href = 'index.html';
      }, 1000);
    }

    // Main
    async function main() {
      // Check configuration
      if (!window.AUTHRIM_CONFIG?.issuer || window.AUTHRIM_CONFIG.issuer === 'https://your-tenant.authrim.com') {
        showStatus('Please configure issuer and clientId in config.js', 'error');
        return;
      }

      try {
        // Initialize SDK
        auth = await AuthrimWeb.createAuthrim({
          issuer: window.AUTHRIM_CONFIG.issuer,
          clientId: window.AUTHRIM_CONFIG.clientId,
        });

        // Check if already logged in
        const isAuthenticated = await auth.session.isAuthenticated();
        if (isAuthenticated) {
          showStatus('Already signed in. Redirecting to home...', 'info');
          setTimeout(function() {
            window.location.href = 'index.html';
          }, 1500);
          return;
        }

        // Check Passkey support
        if (!auth.passkey.isSupported()) {
          $passkeyLoginBtn.disabled = true;
          $passkeySignupBtn.disabled = true;
          var textEl = $passkeyLoginBtn.querySelector('.btn-text');
          if (textEl) textEl.textContent = 'Passkey not supported';
        }

        setupEventListeners();

      } catch (e) {
        console.error('Initialization error:', e);
        showStatus('Initialization failed: ' + e.message, 'error');
      }
    }

    function setupEventListeners() {
      // === Passkey ===
      $passkeyLoginBtn.addEventListener('click', async function() {
        hideStatus();
        setButtonLoading($passkeyLoginBtn, true);

        try {
          var result = await auth.passkey.login();
          if (result.error) {
            showStatus(result.error.message, 'error');
          } else {
            onLoginSuccess();
          }
        } catch (e) {
          showStatus('Passkey authentication failed: ' + e.message, 'error');
        } finally {
          setButtonLoading($passkeyLoginBtn, false);
        }
      });

      $passkeySignupBtn.addEventListener('click', async function() {
        var email = prompt('Enter your email address for registration:');
        if (!email) return;

        hideStatus();
        setButtonLoading($passkeySignupBtn, true);

        try {
          var result = await auth.passkey.signUp({
            email: email,
          });
          if (result.error) {
            showStatus(result.error.message, 'error');
          } else {
            onLoginSuccess();
          }
        } catch (e) {
          showStatus('Passkey registration failed: ' + e.message, 'error');
        } finally {
          setButtonLoading($passkeySignupBtn, false);
        }
      });

      // === Email Code ===
      $sendCodeBtn.addEventListener('click', async function() {
        var email = $emailInput.value.trim();
        if (!email) {
          showStatus('Please enter an email address', 'error');
          return;
        }

        hideStatus();
        setButtonLoading($sendCodeBtn, true);

        try {
          var result = await auth.emailCode.send(email);
          if (result.error) {
            showStatus(result.error.message, 'error');
          } else {
            currentEmail = email;
            $sentEmail.textContent = email;
            $emailStep.classList.add('hidden');
            $codeStep.classList.remove('hidden');
            $codeInput.focus();
            showStatus('Verification code sent. Please check your email.', 'success');
          }
        } catch (e) {
          showStatus('Failed to send code: ' + e.message, 'error');
        } finally {
          setButtonLoading($sendCodeBtn, false);
        }
      });

      $verifyCodeBtn.addEventListener('click', async function() {
        var code = $codeInput.value.trim();
        if (!code) {
          showStatus('Please enter the verification code', 'error');
          return;
        }

        hideStatus();
        setButtonLoading($verifyCodeBtn, true);

        try {
          var result = await auth.emailCode.verify(currentEmail, code);
          if (result.error) {
            showStatus(result.error.message, 'error');
          } else {
            onLoginSuccess();
          }
        } catch (e) {
          showStatus('Verification failed: ' + e.message, 'error');
        } finally {
          setButtonLoading($verifyCodeBtn, false);
        }
      });

      $backToEmailBtn.addEventListener('click', function() {
        hideStatus();
        $codeStep.classList.add('hidden');
        $emailStep.classList.remove('hidden');
        $codeInput.value = '';
        $emailInput.focus();
      });

      // Enter key to submit
      $emailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') $sendCodeBtn.click();
      });
      $codeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') $verifyCodeBtn.click();
      });

      // === Social Login ===
      async function socialLogin(provider, btn) {
        hideStatus();
        setButtonLoading(btn, true);

        try {
          var result = await auth.social.loginWithPopup(provider);
          if (result.error) {
            showStatus(result.error.message, 'error');
          } else {
            onLoginSuccess();
          }
        } catch (e) {
          showStatus(provider + ' login failed: ' + e.message, 'error');
        } finally {
          setButtonLoading(btn, false);
        }
      }

      $googleBtn.addEventListener('click', function() { socialLogin('google', $googleBtn); });
      $githubBtn.addEventListener('click', function() { socialLogin('github', $githubBtn); });
      $appleBtn.addEventListener('click', function() { socialLogin('apple', $appleBtn); });
    }

    main();
  </script>
</body>
</html>
